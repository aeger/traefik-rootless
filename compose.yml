version: "3.8"

services:
  traefik:
    image: docker.io/traefik:v3.1
    container_name: traefik
    restart: unless-stopped

    networks:
      - proxy

    dns:
      - 1.1.1.1
      - 8.8.8.8

    ports:
      - "80:80"
      - "443:443"
      # Intentionally not publishing 8080 (dashboard) directly.
      # Access the dashboard through the router at https://traefik.<domain>/

    env_file:
      - /home/${USER}/traefik/cf.env

    volumes:
      # Podman API socket (Traefik Docker provider talks to it)
      - /run/user/1000/podman/podman.sock:/var/run/docker.sock:ro

      # Runtime state + config
      - /home/${USER}/traefik/data:/data
      - /home/${USER}/traefik/secrets:/secrets:ro
      - /home/${USER}/traefik/dynamic:/dynamic:ro
      - /home/${USER}/traefik/certs:/certs:ro

    labels:
      - "traefik.enable=true"

      # Dashboard router (protected)
      - "traefik.http.routers.traefik.rule=Host(`traefik.az-lab.dev`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.tls.certresolver=le"
      - "traefik.http.routers.traefik.service=api@internal"

      # Middlewares
      - "traefik.http.middlewares.traefik-auth.basicauth.usersfile=/secrets/traefik.htpasswd"
      - "traefik.http.middlewares.traefik-allow.ipallowlist.sourcerange=192.168.1.0/24,10.7.0.0/24,10.89.0.0/16"
      - "traefik.http.routers.traefik.middlewares=traefik-allow,traefik-auth"

    command:
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--api.dashboard=true"

      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

      - "--providers.docker=true"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.exposedbydefault=false"

      - "--providers.file.directory=/dynamic"
      - "--providers.file.watch=true"

      # ACME / Letâ€™s Encrypt via Cloudflare DNS-01
      - "--certificatesresolvers.le.acme.email=almty1@gmail.com"
      - "--certificatesresolvers.le.acme.storage=/data/acme.json"
      - "--certificatesresolvers.le.acme.dnschallenge=true"
      - "--certificatesresolvers.le.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.le.acme.dnschallenge.delaybeforecheck=10"
      - "--certificatesresolvers.le.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"

networks:
  proxy:
    external: true
